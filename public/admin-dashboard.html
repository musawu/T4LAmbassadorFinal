<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T4L Admin Dashboard</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <style>
      .sidebar-toggle { display: none; }
      @media (max-width: 768px) {
        .sidebar-toggle { display: block; position: fixed; top: 1rem; left: 1rem; z-index: 50; background: #4b0d7f; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; position: fixed; height: 100vh; z-index: 40; }
        .sidebar.active { transform: translateX(0); }
        .overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 30; }
        .overlay.active { display: block; }
      }
    </style>
  </head>
  <body class="bg-gray-50 font-sans">
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" id="sidebarToggle"><i class="bx bx-menu text-xl"></i></button>
    <div class="overlay" id="overlay"></div>

    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="sidebar w-20 lg:w-20 md:w-20 bg-white shadow-md flex flex-col items-center py-6 space-y-6 z-40">
        <div class="mb-4">
          <div class="bg-[#4b0d7f] text-white px-3 py-2 rounded-xl font-semibold text-sm">T4L</div>
        </div>
        
        <!-- Review Modal (Full Screen) -->
        <div id="reviewModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
          <div class="bg-white rounded-2xl w-full max-w-6xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <h3 id="reviewTitle" class="text-xl font-semibold text-gray-900">Article Title</h3>
                <span id="reviewStatus" class="px-2 py-1 rounded-lg text-xs font-semibold bg-gray-50 text-gray-700 border border-gray-200">status</span>
              </div>
              <button id="closeReview" class="text-gray-600 hover:text-gray-900"><i class="bx bx-x text-2xl"></i></button>
            </div>
            <div id="reviewContent" class="flex-1 overflow-y-auto">
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-4 md:p-6">
                <div class="lg:col-span-2 space-y-4">
                  <div class="bg-white">
                    <div id="reviewArticleHtml" class="prose max-w-none"></div>
                  </div>
                </div>
                <div class="space-y-4">
                  <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                    <div class="mb-2">
                      <div class="text-sm font-semibold text-gray-800">Author</div>
                      <div id="reviewAuthor" class="text-sm text-gray-700">-</div>
                    </div>
                    <div class="mb-2">
                      <div class="text-sm font-semibold text-gray-800">Company</div>
                      <div id="reviewCompany" class="text-sm text-gray-700">-</div>
                    </div>
                    <div>
                      <div class="text-sm font-semibold text-gray-800">Submitted</div>
                      <div id="reviewDate" class="text-sm text-gray-700">-</div>
                    </div>
                  </div>

                  <!-- Previous Admin Feedback -->
                  <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <div class="text-sm font-semibold text-gray-800 mb-3">Previous Feedback</div>
                    <div id="previousFeedback" class="space-y-3 max-h-64 overflow-y-auto">
                      <div class="text-sm text-gray-500 text-center py-4">No previous feedback</div>
                    </div>
                  </div>

                  <!-- Request Change Section -->
                  <div id="requestChangeSection" class="bg-white rounded-xl p-4 border border-gray-200">
                    <div class="text-sm font-semibold text-gray-800 mb-3">Request Changes</div>
                    <div class="space-y-3">
                      <textarea id="notifMessage" rows="4" placeholder="Add feedback or instructions for the ambassador..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-800 bg-white"></textarea>
                      <button id="btnRequestChange" type="button" class="w-full px-4 py-2 rounded-lg text-white font-semibold bg-orange-600 hover:bg-orange-700 flex items-center justify-center gap-2">
                        <i class="bx bx-send text-lg"></i>
                        <span>Send Request Changes</span>
                      </button>
                    </div>
                  </div>

                  <!-- Article Status Management -->
                  <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <div class="text-sm font-semibold text-gray-800 mb-3">Article Status</div>
                    <div class="space-y-3">
                      <select id="articleStatusSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                        <option value="pending">Pending Review</option>
                        <option value="needs_update">Needs Update</option>
                        <option value="approved">Approved</option>
                        <option value="published">Published</option>
                        <option value="rejected">Rejected</option>
                      </select>
                      <button id="btnUpdateStatus" class="w-full px-4 py-2 rounded-lg text-white font-semibold bg-purple-600 hover:bg-purple-700">Update Status</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <nav class="flex flex-col space-y-4 text-gray-700 w-full">
          <div class="flex flex-col items-center py-2 px-3">
            <i class="bx bxs-dashboard text-2xl text-[#4b0d9f]"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600">Admin</span>
          </div>
          <a href="/profile.html" class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-purple-50">
            <i class="bx bx-user text-2xl group-hover:text-[#4b0d9f] group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-[#4b0d9f] transition-colors duration-200">Profile</span>
          </a>
          <div class="flex flex-col items-center cursor-pointer group transition-all duration-200 py-2 px-3 rounded-lg hover:bg-red-50" id="logoutBtn">
            <i class="bx bx-log-out text-2xl group-hover:text-red-600 group-hover:scale-110 transition-all duration-200"></i>
            <span class="text-[10px] mt-1.5 font-medium text-gray-600 group-hover:text-red-600 transition-colors duration-200">Logout</span>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-4 md:p-6 lg:p-6">
        <!-- Top Navbar -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
          <h1 class="text-xl font-semibold text-gray-900">T4L Admin Console</h1>
          <div class="flex items-center space-x-4 w-full md:w-auto">
            <div class="relative flex-1 md:flex-none">
              <input id="globalSearch" type="text" placeholder="Search users..." class="border border-gray-400 rounded-full pl-10 pr-4 py-2 text-sm w-full md:w-80 focus:outline-none focus:ring-2 focus:ring-purple-500" />
              <i class="bx bx-search absolute left-3 top-2.5 text-gray-900"></i>
            </div>
            <div class="w-10 h-10 bg-[#4b0d7f] flex items-center justify-center rounded-full font-bold text-white" id="avatarInitials">AD</div>
          </div>
        </header>

        <!-- Tabs -->
        <div class="bg-white rounded-2xl border border-gray-100 p-2 inline-flex mb-4">
          <button id="tabAmbassadors" class="px-4 py-2 rounded-xl text-sm font-semibold text-white" style="background-color:#4b0d7f">Ambassadors</button>
          <button id="tabPartners" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-700">Partners</button>
          <button id="tabArticles" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-700">Articles</button>
        </div>

        <!-- Article Status Filter Buttons (only visible on Articles tab) -->
        <div id="articleStatusFilters" class="bg-white rounded-2xl border border-gray-100 p-2 flex flex-wrap gap-2 mb-4" style="display: none;">
          <button id="filterAll" class="px-4 py-2 rounded-xl text-sm font-semibold text-white" style="background-color:#4b0d7f">All Articles</button>
          <button id="filterPending" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-100">Pending Review</button>
          <button id="filterNeedsUpdate" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-100">Needs Update</button>
          <button id="filterApproved" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-100">Approved</button>
          <button id="filterPublished" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-100">Published</button>
          <button id="filterRejected" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-100">Rejected</button>
        </div>

        <!-- Filters -->
        <section class="bg-white rounded-2xl p-4 md:p-6 mb-4 border border-gray-100">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Status</label>
              <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                <option value="">All</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="approved">Approved</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-semibold text-gray-800 block mb-2">Page Size</label>
              <select id="pageSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="refreshBtn" class="w-full sm:w-auto px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Refresh</button>
            </div>
          </div>
        </section>

        <!-- Table/Card Container -->
        <section class="bg-white rounded-2xl p-0 md:p-0 border border-gray-100 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full text-left">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr class="text-gray-600 text-sm" id="tableHeaders">
                  <th class="px-4 py-3 font-semibold">Name</th>
                  <th class="px-4 py-3 font-semibold">Email</th>
                  <th class="px-4 py-3 font-semibold">Status</th>
                  <th class="px-4 py-3 font-semibold">Org (Partners)</th>
                  <th class="px-4 py-3 font-semibold text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="listBody"></tbody>
            </table>
          </div>
          <div id="emptyState" class="hidden p-8 text-center text-gray-600">No results found.</div>
          <div class="flex items-center justify-between p-4 border-t border-gray-100 text-sm">
            <div id="resultsSummary" class="text-gray-600"></div>
            <div class="flex items-center gap-2">
              <button id="prevPage" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">Prev</button>
              <span id="pageInfo" class="text-gray-700"></span>
              <button id="nextPage" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">Next</button>
            </div>
          </div>
        </section>

        <!-- Edit Modal -->
        <div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
          <div class="bg-white rounded-2xl w-full max-w-6xl shadow-lg">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
              <h3 class="text-lg font-semibold">Edit User</h3>
              <button id="closeEdit" class="text-gray-600 hover:text-gray-900"><i class="bx bx-x text-2xl"></i></button>
            </div>
            <div class="p-4 space-y-4">
              <div>
                <label class="text-sm font-semibold text-gray-800 block mb-2">Name</label>
                <input id="editName" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-800 block mb-2">Status</label>
                <select id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="active">active</option>
                  <option value="inactive">inactive</option>
                  <option value="approved">approved</option>
                  <option value="pending">pending</option>
                  <option value="rejected">rejected</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-800 block mb-2">Access Code</label>
                <input id="editAccessCode" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg uppercase" />
              </div>
              <!-- Article Preview (Articles Only) -->
              <div id="articleFields" class="hidden">
                <div>
                  <label class="text-sm font-semibold text-gray-800 block mb-2">Article Title</label>
                  <input id="editArticleTitle" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly />
                </div>
                <div>
                  <label class="text-sm font-semibold text-gray-800 block mb-2">Author Info</label>
                  <input id="editArticleAuthor" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly />
                </div>
                <div>
                  <label class="text-sm font-semibold text-gray-800 block mb-2">Submitted Date</label>
                  <input id="editArticleDate" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly />
                </div>
              </div>
              <div id="partnerFields" class="hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm font-semibold text-gray-800 block mb-2">Organization</label>
                    <input id="editOrg" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-gray-800 block mb-2">Contact Name</label>
                    <input id="editContact" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                </div>
              </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex items-center justify-end gap-2">
              <button id="cancelEdit" class="px-4 py-2 rounded-lg border border-gray-300">Cancel</button>
              <button id="saveEdit" class="px-4 py-2 rounded-lg text-white font-semibold" style="background-color:#4b0d7f">Save</button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Simple toast helper
      function showToast(msg, isError) {
        try {
          const div = document.createElement('div');
          div.textContent = String(msg || '');
          div.className = `fixed top-4 right-4 z-[100] px-4 py-3 rounded-lg shadow-lg text-sm ${isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
          document.body.appendChild(div);
          setTimeout(() => div.remove(), 3000);
        } catch (_) {}
      }

      // Minimal state
      const state = {
        tab: 'ambassadors',
        q: '',
        status: '',
        articleStatusFilter: '',
        limit: 20,
        offset: 0,
        total: 0,
        items: [],
        editing: null,
        reviewing: null
      };

      // Utils
      function debounce(fn, wait) {
        let t; return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); };
      }

      // Auth guard + header setup
      function ensureAdmin() {
        return fetch('/api/me', { credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('auth'); return r.json(); })
          .then(me => { if (me.role !== 'admin') throw new Error('forbidden'); return me; })
          .catch(() => { window.location.href = '/admin-signin'; throw new Error('redirect'); });
      }

      // Render
      function renderList() {
        updateTableHeaders();
        const tbody = document.getElementById('listBody');
        const empty = document.getElementById('emptyState');
        tbody.innerHTML = '';
        if (!state.items.length) {
          empty.classList.remove('hidden');
        } else {
          empty.classList.add('hidden');
          state.items.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 hover:bg-gray-50';
            if (state.tab === 'articles') {
              const title = item.title || '-';
              const author = item.authorNameRole || '-';
              const date = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '-';
              const company = (item.companyDescription || '-').toString();
              const companyShort = company.length > 60 ? company.substring(0, 57) + 'â€¦' : company;
              tr.innerHTML = `
                <td class="px-4 py-3 text-sm text-gray-900">${title}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${author}</td>
                <td class="px-4 py-3 text-sm text-gray-700" title="${company.replace(/\"/g,'&quot;')}">${companyShort}</td>
                <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-lg border ${badgeClass(item.status)}">${item.status || '-'}</span></td>
                <td class="px-4 py-3 text-sm text-gray-700">${date}</td>
                <td class="px-4 py-3 text-sm text-right">
                  <button class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 mr-2" data-action="review" data-id="${item.id}">View Details</button>
                  <button class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 mr-2" data-action="edit" data-id="${item.id}">Edit</button>
                  <button class="px-3 py-1.5 rounded-lg border border-red-300 text-red-700 hover:bg-red-50" data-action="delete" data-id="${item.id}">Delete</button>
                </td>
              `;
            } else {
              const name = item.name || '-';
              const org = item.organizationName || '-';
              tr.innerHTML = `
                <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${item.email}</td>
                <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-lg border ${badgeClass(item.status)}">${item.status || '-'}</span></td>
                <td class="px-4 py-3 text-sm text-gray-700">${state.tab === 'partners' ? org : '-'}</td>
                <td class="px-4 py-3 text-sm text-right">
                  <button class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 mr-2" data-action="edit" data-id="${item.id}">Edit</button>
                  <button class="px-3 py-1.5 rounded-lg border border-red-300 text-red-700 hover:bg-red-50" data-action="delete" data-id="${item.id}">Delete</button>
                </td>
              `;
            }
            tbody.appendChild(tr);
          });
        }
        renderPagination();
        bindRowActions();
        renderSummary();
      }

      function updateTableHeaders() {
        const headers = document.getElementById('tableHeaders');
        if (!headers) return;
        if (state.tab === 'articles') {
          headers.innerHTML = `
            <th class="px-4 py-3 font-semibold">Title</th>
            <th class="px-4 py-3 font-semibold">Author</th>
            <th class="px-4 py-3 font-semibold">Company</th>
            <th class="px-4 py-3 font-semibold">Status</th>
            <th class="px-4 py-3 font-semibold">Date</th>
            <th class="px-4 py-3 font-semibold text-right">Actions</th>
          `;
        } else {
          headers.innerHTML = `
            <th class="px-4 py-3 font-semibold">Name</th>
            <th class="px-4 py-3 font-semibold">Email</th>
            <th class="px-4 py-3 font-semibold">Status</th>
            <th class="px-4 py-3 font-semibold">Org (Partners)</th>
            <th class="px-4 py-3 font-semibold text-right">Actions</th>
          `;
        }
      }

      function renderSummary() {
        const start = state.total ? state.offset + 1 : 0;
        const end = Math.min(state.offset + state.limit, state.total);
        document.getElementById('resultsSummary').textContent = `${start}-${end} of ${state.total}`;
      }

      function renderPagination() {
        const pageSpan = document.getElementById('pageInfo');
        const currentPage = Math.floor(state.offset / state.limit) + 1;
        const totalPages = Math.max(1, Math.ceil(state.total / state.limit));
        pageSpan.textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevPage').disabled = state.offset <= 0;
        document.getElementById('nextPage').disabled = state.offset + state.limit >= state.total;
      }

      function badgeClass(status) {
        const s = String(status || '').toLowerCase();
        if (s === 'active' || s === 'approved') return 'border-green-300 text-green-700 bg-green-50';
        if (s === 'pending') return 'border-yellow-300 text-yellow-700 bg-yellow-50';
        if (s === 'needs_update') return 'border-orange-300 text-orange-700 bg-orange-50';
        if (s === 'published') return 'border-blue-300 text-blue-700 bg-blue-50';
        if (s === 'rejected' || s === 'inactive') return 'border-red-300 text-red-700 bg-red-50';
        return 'border-gray-300 text-gray-700 bg-gray-50';
      }

      function setActiveArticleFilter(activeId) {
        const filterIds = ['filterAll', 'filterPending', 'filterNeedsUpdate', 'filterApproved', 'filterPublished', 'filterRejected'];
        filterIds.forEach(id => {
          const btn = document.getElementById(id);
          if (!btn) return;
          if (id === activeId) {
            btn.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-white';
            btn.style.backgroundColor = '#4b0d7f';
          } else {
            btn.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-100';
            btn.style.backgroundColor = '';
          }
        });
      }

      // Local storage helpers
      const LS_KEY_ARTICLES = 't4l.admin.articles.v1';
      function readLsArticles() {
        try {
          const raw = localStorage.getItem(LS_KEY_ARTICLES);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch (_) { return []; }
      }
      function writeLsArticles(articles) {
        try { localStorage.setItem(LS_KEY_ARTICLES, JSON.stringify(articles || [])); } catch (_) {}
      }
      function findLsArticleById(id) {
        const all = readLsArticles();
        return all.find(a => String(a.id) === String(id));
      }
      function upsertLsArticle(article) {
        const all = readLsArticles();
        const idx = all.findIndex(a => String(a.id) === String(article.id));
        if (idx >= 0) {
          all[idx] = { ...all[idx], ...article, updatedAt: Date.now() };
        } else {
          const genId = (globalThis.crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
          all.unshift({ id: genId, createdAt: Date.now(), status: 'pending', ...article });
        }
        writeLsArticles(all);
        return idx >= 0 ? all[idx] : all[0];
      }
      function deleteLsArticle(id) {
        const all = readLsArticles().filter(a => String(a.id) !== String(id));
        writeLsArticles(all);
      }

      function fetchList() {
        if (state.tab === 'articles') {
          const params = new URLSearchParams();
          if (state.q) params.set('q', state.q);
          if (state.articleStatusFilter) params.set('status', state.articleStatusFilter);
          params.set('limit', String(state.limit));
          params.set('offset', String(state.offset));
          return fetch(`/admin/api/articles?${params.toString()}`, { credentials: 'include' })
            .then(r => { if (!r.ok) throw new Error('load'); return r.json(); })
            .then(data => {
              const items = data.items || [];
              const total = data.total || items.length;
              try { writeLsArticles(items); } catch (_) {}
              state.items = items;
              state.total = total;
              renderList();
            })
            .catch(() => {
              const q = (state.q || '').toLowerCase();
              const status = (state.articleStatusFilter || '').toLowerCase();
              let items = readLsArticles();
              if (q) {
                items = items.filter(a => {
                  const hay = [a.title, a.authorNameRole, a.companyDescription, a.contentHtml]
                    .map(v => (v || '').toString().toLowerCase())
                    .join(' \u0000 ');
                  return hay.includes(q);
                });
              }
              if (status) items = items.filter(a => String(a.status || '').toLowerCase() === status);
              state.total = items.length;
              const start = state.offset;
              const end = Math.min(start + state.limit, items.length);
              state.items = items.slice(start, end);
              renderList();
            });
        }

        let base = '/admin/api/ambassadors';
        if (state.tab === 'partners') base = '/admin/api/partners';
        const params = new URLSearchParams();
        if (state.q) params.set('q', state.q);
        if (state.status) params.set('status', state.status);
        params.set('limit', String(state.limit));
        params.set('offset', String(state.offset));
        return fetch(`${base}?${params.toString()}`, { credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('load'); return r.json(); })
          .then(data => { state.items = data.items || []; state.total = data.total || 0; renderList(); })
          .catch(() => { state.items = []; state.total = 0; renderList(); });
      }

      function openEditModal(id) {
        const isPartner = state.tab === 'partners';
        const isArticle = state.tab === 'articles';
        if (isArticle) {
          fetch(`/admin/api/articles/${id}`, { credentials: 'include' })
            .then(r => { if (!r.ok) throw new Error('load'); return r.json(); })
            .then(user => {
              try { upsertLsArticle(user); } catch (_) {}
              state.editing = { id, user, isPartner, isArticle };

              const partnerFields = document.getElementById('partnerFields');
              const articleFields = document.getElementById('articleFields');

              document.getElementById('editName').value = '';
              document.getElementById('editName').closest('div').style.display = 'none';
              document.getElementById('editAccessCode').closest('div').style.display = 'none';
              document.getElementById('editStatus').value = (user.status || '').toLowerCase();
              partnerFields.classList.add('hidden');
              articleFields.classList.remove('hidden');
              document.getElementById('editArticleTitle').value = user.title || '';
              document.getElementById('editArticleAuthor').value = user.authorNameRole || '';
              const date = user.createdAt ? new Date(user.createdAt).toLocaleString() : '';
              document.getElementById('editArticleDate').value = date;
              document.getElementById('editModal').classList.remove('hidden');
              document.getElementById('editModal').classList.add('flex');
            })
            .catch(() => {
              const user = findLsArticleById(id);
              if (!user) { showToast('Article not found', true); return; }
              state.editing = { id, user, isPartner, isArticle };
              const partnerFields = document.getElementById('partnerFields');
              const articleFields = document.getElementById('articleFields');
              document.getElementById('editName').value = '';
              document.getElementById('editName').closest('div').style.display = 'none';
              document.getElementById('editAccessCode').closest('div').style.display = 'none';
              document.getElementById('editStatus').value = (user.status || '').toLowerCase();
              partnerFields.classList.add('hidden');
              articleFields.classList.remove('hidden');
              document.getElementById('editArticleTitle').value = user.title || '';
              document.getElementById('editArticleAuthor').value = user.authorNameRole || '';
              const date = user.createdAt ? new Date(user.createdAt).toLocaleString() : '';
              document.getElementById('editArticleDate').value = date;
              document.getElementById('editModal').classList.remove('hidden');
              document.getElementById('editModal').classList.add('flex');
            });
          return;
        }

        let url = `/admin/api/ambassadors/${id}`;
        if (isPartner) url = `/admin/api/partners/${id}`;
        fetch(url, { credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('load'); return r.json(); })
          .then(user => {
            state.editing = { id, user, isPartner, isArticle };

            const partnerFields = document.getElementById('partnerFields');
            const articleFields = document.getElementById('articleFields');

            document.getElementById('editName').closest('div').style.display = 'block';
            document.getElementById('editAccessCode').closest('div').style.display = 'block';
            document.getElementById('editName').value = user.name || user.contactName || '';
            document.getElementById('editStatus').value = (user.status || '').toLowerCase();
            document.getElementById('editAccessCode').value = user.accessCode || '';
            articleFields.classList.add('hidden');
            
            if (isPartner) {
              partnerFields.classList.remove('hidden');
              document.getElementById('editOrg').value = user.organizationName || '';
              document.getElementById('editContact').value = user.contactName || '';
            } else {
              partnerFields.classList.add('hidden');
              document.getElementById('editOrg').value = '';
              document.getElementById('editContact').value = '';
            }
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
          })
          .catch(() => {});
      }

      function saveEdit() {
        if (!state.editing) return;
        const { id, isPartner, isArticle } = state.editing;
        const body = {
          status: document.getElementById('editStatus').value || undefined
        };
        if (!isArticle) {
          body.accessCode = document.getElementById('editAccessCode').value || undefined;
        }
        const name = document.getElementById('editName').value.trim();
        if (isPartner) {
          body.organizationName = document.getElementById('editOrg').value.trim() || undefined;
          body.contactName = name || undefined;
        } else {
          body.name = name || undefined;
        }
        if (isArticle) {
          fetch(`/admin/api/articles/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: body.status }), credentials: 'include' })
            .then(r => { if (!r.ok) throw new Error('save'); return r.json(); })
            .then(({ article }) => {
              try { upsertLsArticle(article); } catch (_) {}
              closeEdit();
              fetchList();
            })
            .catch(() => { closeEdit(); showToast('Failed to save', true); });
          return;
        }

        let url = `/admin/api/ambassadors/${id}`;
        if (isPartner) url = `/admin/api/partners/${id}`;
        fetch(url, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body), credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('save'); return r.json(); })
          .then(() => { closeEdit(); fetchList(); })
          .catch(() => { closeEdit(); });
      }

      function closeEdit() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('editModal').classList.remove('flex');
        state.editing = null;
      }

      function deleteItem(id) {
        const itemType = state.tab === 'articles' ? 'article' : 'user';
        if (!confirm(`Are you sure you want to delete this ${itemType}? This action cannot be undone.`)) return;
        if (state.tab === 'articles') {
          fetch(`/admin/api/articles/${id}`, { method: 'DELETE', credentials: 'include' })
            .then(r => { if (!r.ok) throw new Error('delete'); })
            .then(() => { deleteLsArticle(id); fetchList(); })
            .catch(() => { showToast('Delete failed', true); });
          return;
        }
        let url = `/admin/api/ambassadors/${id}`;
        if (state.tab === 'partners') url = `/admin/api/partners/${id}`;
        fetch(url, { method: 'DELETE', credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('delete'); })
          .then(() => { fetchList(); })
          .catch(() => {});
      }

      function bindRowActions() {
        const tbody = document.getElementById('listBody');
        if (!tbody) return;
        const clone = tbody.cloneNode(true);
        tbody.parentNode.replaceChild(clone, tbody);
        clone.addEventListener('click', (e) => {
          const target = e.target.closest('[data-action]');
          if (!target) return;
          const action = target.getAttribute('data-action');
          const id = target.getAttribute('data-id');
          if (action === 'review') { openReviewModal(id); return; }
          if (action === 'edit') { openEditModal(id); return; }
          if (action === 'delete') { deleteItem(id); return; }
        });
      }
      
      // Review modal
      function openReviewModal(id) {
        fetch(`/admin/api/articles/${id}`, { credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('load'); return r.json(); })
          .then(article => {
            try { upsertLsArticle(article); } catch (_) {}
            state.reviewing = { id, article };
            renderReviewModal(article);
            const modal = document.getElementById('reviewModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Bind modal events after opening
            bindReviewModalEvents();
          })
          .catch(() => {
            const article = findLsArticleById(id);
            if (!article) { showToast('Failed to load article details', true); return; }
            state.reviewing = { id, article };
            renderReviewModal(article);
            const modal = document.getElementById('reviewModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Bind modal events after opening
            bindReviewModalEvents();
          });
      }

      function closeReviewModal() {
        const modal = document.getElementById('reviewModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        state.reviewing = null;
      }

      function statusBadgeClass(status) {
        const s = String(status || '').toLowerCase();
        if (s === 'approved') return 'bg-green-50 text-green-700 border border-green-200';
        if (s === 'rejected') return 'bg-red-50 text-red-700 border border-red-200';
        if (s === 'published') return 'bg-blue-50 text-blue-700 border border-blue-200';
        if (s === 'pending') return 'bg-yellow-50 text-yellow-700 border border-yellow-200';
        if (s === 'needs_update') return 'bg-orange-50 text-orange-700 border border-orange-200';
        return 'bg-gray-50 text-gray-700 border border-gray-200';
      }

      function renderReviewModal(article) {
        const dateStr = article.createdAt ? new Date(article.createdAt).toLocaleString() : '-';
        
        document.getElementById('reviewTitle').textContent = article.title || '-';
        document.getElementById('reviewAuthor').textContent = article.authorNameRole || '-';
        document.getElementById('reviewCompany').textContent = article.companyDescription || '-';
        document.getElementById('reviewDate').textContent = dateStr;
        
        const statusEl = document.getElementById('reviewStatus');
        statusEl.textContent = (article.status || '').toLowerCase();
        statusEl.className = `px-2 py-1 rounded-lg text-xs font-semibold ${statusBadgeClass(article.status)}`;
        
        const content = document.getElementById('reviewArticleHtml');
        content.innerHTML = article.contentHtml || '<p class="text-gray-500">No content available</p>';
        
        document.getElementById('previousFeedback').innerHTML = '<div class="text-sm text-gray-500 text-center py-4">Loading feedback...</div>';
        document.getElementById('notifMessage').value = '';
        
        const statusSelect = document.getElementById('articleStatusSelect');
        if (statusSelect) {
          statusSelect.value = String(article.status || 'pending').toLowerCase();
        }
        
        const requestChangeSection = document.getElementById('requestChangeSection');
        const requestChangeBtn = document.getElementById('btnRequestChange');
        if (requestChangeSection) {
          requestChangeSection.style.display = 'block';
          requestChangeSection.style.visibility = 'visible';
        }
        if (requestChangeBtn) {
          requestChangeBtn.style.display = 'flex';
          requestChangeBtn.style.visibility = 'visible';
          requestChangeBtn.style.opacity = '1';
          requestChangeBtn.disabled = false;
        }
        
        loadPreviousFeedback(article.id);
      }
      
      function loadPreviousFeedback(articleId) {
        fetch(`/admin/api/articles/${articleId}/notifications`, { credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('load'); return r.json(); })
          .then(data => {
            const feedbackContainer = document.getElementById('previousFeedback');
            const notifications = data.items || [];
            
            if (notifications.length === 0) {
              feedbackContainer.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">No previous feedback</div>';
              return;
            }
            
            feedbackContainer.innerHTML = notifications.map(notif => {
              const date = new Date(notif.createdAt || Date.now()).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              const isRequestChange = String(notif.type || '').toLowerCase() === 'needs_update';
              
              return `
                <div class="border-l-4 ${isRequestChange ? 'border-orange-500' : 'border-purple-500'} bg-gray-50 rounded p-3">
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-semibold text-gray-700">${escapeHtml(notif.adminName || 'Admin')}</span>
                      ${isRequestChange ? '<span class="text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded">Request Change</span>' : ''}
                    </div>
                    <span class="text-xs text-gray-500">${date}</span>
                  </div>
                  <p class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(notif.message || 'No message')}</p>
                </div>
              `;
            }).join('');
          })
          .catch(() => {
            document.getElementById('previousFeedback').innerHTML = '<div class="text-sm text-gray-500 text-center py-4">Failed to load feedback</div>';
          });
      }
      
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function updateArticleStatus(newStatus) {
        if (!state.reviewing) return;
        const id = state.reviewing.id;
        fetch(`/admin/api/articles/${id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }), credentials: 'include' })
          .then(r => { if (!r.ok) throw new Error('save'); return r.json(); })
          .then(({ article }) => {
            try { upsertLsArticle(article); } catch (_) {}
            showToast(`Status updated to ${article.status}`);
            const idx = state.items.findIndex(it => String(it.id) === String(id));
            if (idx >= 0) { state.items[idx].status = article.status; renderList(); }
            renderReviewModal(article);
            bindReviewModalEvents();
          })
          .catch(() => { showToast('Failed to update status', true); });
      }

      function requestChanges() {
        console.log('requestChanges called', state.reviewing);
        
        if (!state.reviewing) {
          console.log('No article being reviewed');
          showToast('No article selected', true);
          return;
        }
        
        const id = state.reviewing.id;
        const messageInput = document.getElementById('notifMessage');
        const message = messageInput ? messageInput.value.trim() : '';
        
        console.log('Message:', message);
        
        if (!message) {
          showToast('Please provide feedback message', true);
          return;
        }
        
        console.log('Sending request...');
        
        fetch('/admin/api/notifications', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ articleId: id, type: 'needs_update', message }), 
          credentials: 'include' 
        })
          .then(r => { 
            console.log('Response status:', r.status);
            if (!r.ok) throw new Error('notify'); 
            return r.json(); 
          })
          .then((data) => { 
            console.log('Success:', data);
            showToast('Change request sent to ambassador');
            if (messageInput) messageInput.value = '';
            
            loadPreviousFeedback(id);
            fetch(`/admin/api/articles/${id}`, { credentials: 'include' })
              .then(r => r.json())
              .then(article => {
                state.reviewing.article = article;
                renderReviewModal(article);
                const idx = state.items.findIndex(it => String(it.id) === String(id));
                if (idx >= 0) { state.items[idx].status = article.status; renderList(); }
                
                bindReviewModalEvents();
              })
              .catch(() => {});
          })
          .catch((err) => { 
            console.error('Error:', err);
            showToast('Failed to send change request', true); 
          });
      }

      // Bind review modal events directly (called after modal opens)
      function bindReviewModalEvents() {
        console.log('Binding review modal events');
        
        const btnRequestChange = document.getElementById('btnRequestChange');
        const btnUpdateStatus = document.getElementById('btnUpdateStatus');
        const closeReview = document.getElementById('closeReview');
        
        if (btnRequestChange) {
          const newBtn = btnRequestChange.cloneNode(true);
          btnRequestChange.parentNode.replaceChild(newBtn, btnRequestChange);
          
          newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Request changes button clicked');
            requestChanges();
          });
        }
        
        if (btnUpdateStatus) {
          const newBtn = btnUpdateStatus.cloneNode(true);
          btnUpdateStatus.parentNode.replaceChild(newBtn, btnUpdateStatus);
          
          newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Update status button clicked');
            if (!state.reviewing) return;
            const statusSelect = document.getElementById('articleStatusSelect');
            const newStatus = statusSelect ? statusSelect.value : null;
            if (newStatus) {
              updateArticleStatus(newStatus);
            }
          });
        }
        
        if (closeReview) {
          const newBtn = closeReview.cloneNode(true);
          closeReview.parentNode.replaceChild(newBtn, closeReview);
          
          newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Close review button clicked');
            closeReviewModal();
          });
        }
      }

      // Event bindings
      function bindUI() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('overlay');
        sidebarToggle.addEventListener('click', () => { sidebar.classList.toggle('active'); overlay.classList.toggle('active'); });
        overlay.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); });

        document.getElementById('globalSearch').addEventListener('input', debounce(e => {
          state.q = e.target.value.trim();
          state.offset = 0; fetchList();
        }, 300));

        document.getElementById('statusFilter').addEventListener('change', e => {
          state.status = e.target.value;
          state.offset = 0; fetchList();
        });

        document.getElementById('pageSize').addEventListener('change', e => {
          state.limit = parseInt(e.target.value, 10) || 20;
          state.offset = 0; fetchList();
        });

        document.getElementById('refreshBtn').addEventListener('click', () => fetchList());

        document.getElementById('prevPage').addEventListener('click', () => { if (state.offset > 0) { state.offset = Math.max(0, state.offset - state.limit); fetchList(); } });
        document.getElementById('nextPage').addEventListener('click', () => { if (state.offset + state.limit < state.total) { state.offset = state.offset + state.limit; fetchList(); } });

        document.getElementById('filterAll').addEventListener('click', () => {
          state.articleStatusFilter = '';
          state.offset = 0;
          setActiveArticleFilter('filterAll');
          fetchList();
        });
        
        document.getElementById('filterPending').addEventListener('click', () => {
          state.articleStatusFilter = 'pending';
          state.offset = 0;
          setActiveArticleFilter('filterPending');
          fetchList();
        });
        
        document.getElementById('filterNeedsUpdate').addEventListener('click', () => {
          state.articleStatusFilter = 'needs_update';
          state.offset = 0;
          setActiveArticleFilter('filterNeedsUpdate');
          fetchList();
        });
        
        document.getElementById('filterApproved').addEventListener('click', () => {
          state.articleStatusFilter = 'approved';
          state.offset = 0;
          setActiveArticleFilter('filterApproved');
          fetchList();
        });
        
        document.getElementById('filterPublished').addEventListener('click', () => {
          state.articleStatusFilter = 'published';
          state.offset = 0;
          setActiveArticleFilter('filterPublished');
          fetchList();
        });
        
        document.getElementById('filterRejected').addEventListener('click', () => {
          state.articleStatusFilter = 'rejected';
          state.offset = 0;
          setActiveArticleFilter('filterRejected');
          fetchList();
        });

        document.getElementById('tabAmbassadors').addEventListener('click', () => {
          state.tab = 'ambassadors';
          state.offset = 0;
          const amb = document.getElementById('tabAmbassadors');
          const par = document.getElementById('tabPartners');
          const art = document.getElementById('tabArticles');
          amb.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-white';
          par.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-gray-700';
          art.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-gray-700';
          amb.style.backgroundColor = '#4b0d7f';
          par.style.backgroundColor = '';
          art.style.backgroundColor = '';
          
          const articleFilters = document.getElementById('articleStatusFilters');
          if (articleFilters) articleFilters.style.display = 'none';
          
          fetchList();
        });
        
        document.getElementById('tabPartners').addEventListener('click', () => {
          state.tab = 'partners';
          state.offset = 0;
          const amb = document.getElementById('tabAmbassadors');
          const par = document.getElementById('tabPartners');
          const art = document.getElementById('tabArticles');
          par.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-white';
          amb.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-gray-700';
          art.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-gray-700';
          par.style.backgroundColor = '#4b0d7f';
          amb.style.backgroundColor = '';
          art.style.backgroundColor = '';
          
          const articleFilters = document.getElementById('articleStatusFilters');
          if (articleFilters) articleFilters.style.display = 'none';
          
          fetchList();
        });
        
        document.getElementById('tabArticles').addEventListener('click', () => {
          state.tab = 'articles';
          state.offset = 0;
          state.articleStatusFilter = '';
          const amb = document.getElementById('tabAmbassadors');
          const par = document.getElementById('tabPartners');
          const art = document.getElementById('tabArticles');
          art.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-white';
          amb.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-gray-700';
          par.className = 'px-4 py-2 rounded-xl text-sm font-semibold text-gray-700';
          art.style.backgroundColor = '#4b0d7f';
          amb.style.backgroundColor = '';
          par.style.backgroundColor = '';
          
          const articleFilters = document.getElementById('articleStatusFilters');
          if (articleFilters) articleFilters.style.display = 'flex';
          
          setActiveArticleFilter('filterAll');
          
          fetchList();
        });

        document.getElementById('closeEdit').addEventListener('click', closeEdit);
        document.getElementById('cancelEdit').addEventListener('click', closeEdit);
        document.getElementById('saveEdit').addEventListener('click', saveEdit);

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            fetch('/logout', { method: 'POST' })
              .then(() => { window.location.href = '/admin-signin'; })
              .catch(() => { window.location.href = '/admin-signin'; });
          });
        }
      }

      // Init
      document.addEventListener('DOMContentLoaded', function() {
        ensureAdmin().then(me => {
          const initials = (me.name || 'Admin').split(' ').map(w => w[0]).join('').toUpperCase().substring(0,2);
          const avatar = document.getElementById('avatarInitials');
          if (avatar) avatar.textContent = initials;
          bindUI();
          fetchList();
        }).catch(() => {});
      });
    </script>
  </body>
</html>